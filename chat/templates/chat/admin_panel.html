{% extends 'chat/base.html' %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="flex flex-col h-screen overflow-hidden bg-black text-white font-mono">
        
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/80 backdrop-blur-md z-50">
    
            <div>
                <h1 class="text-xl font-bold text-yellow-500 tracking-[0.2em] flex items-center gap-3">
                    <span class="text-2xl">üïπÔ∏è</span> CONTROL TOWER 
                    <span class="text-[10px] bg-red-600/20 text-red-500 border border-red-900 px-2 py-0.5 rounded">GOD MODE</span>
                </h1>
                <p class="text-[10px] text-gray-500 mt-1">SYSTEM: {{ config.site_name }} | XP RATE: {{ config.xp_per_message }}x</p>
            </div>

            <div class="flex gap-3">
                <a href="/super-dashboard/" class="px-4 py-1.5 bg-blue-900/30 hover:bg-blue-800/50 border border-blue-700 text-blue-200 rounded text-xs font-bold transition flex items-center gap-2 shadow-[0_0_15px_rgba(0,100,255,0.3)]">
                    üìä Analytics
                </a>
                <a href="/admin/" class="px-4 py-1.5 bg-green-900/30 hover:bg-green-800/50 border border-green-700 text-green-200 rounded text-xs font-bold transition flex items-center gap-2 shadow-[0_0_15px_rgba(0,255,100,0.3)]">
                    ‚öôÔ∏è DB Admin
                </a>
            </div>

            <div class="flex gap-3 items-center">
                <form method="POST" action="{% url 'clear_all_chats' %}" onsubmit="return confirm('Are you sure? This will delete ALL messages.');">
                    {% csrf_token %}
                    <button class="px-4 py-1.5 bg-red-900/50 hover:bg-red-800 border border-red-700 text-red-200 rounded text-xs transition">üóëÔ∏è WIPE CHATS</button>
                </form>
                <a href="{% url 'home' %}" class="px-4 py-1.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-xs transition">EXIT</a>
            </div>

        </div>

    <div class="flex-1 overflow-y-auto p-6 grid grid-cols-12 gap-6">
        
        <div class="col-span-8 space-y-6">
            
           

           

            <div class="p-5 bg-gray-900 rounded-xl border border-purple-500/30">
                <h3 class="text-xs font-bold text-purple-400 uppercase mb-4 flex items-center gap-2">‚öôÔ∏è System Configuration</h3>
                <form method="POST" action="{% url 'update_settings' %}" class="grid grid-cols-2 gap-6">
                    {% csrf_token %}
                    <div><label class="text-[10px] text-gray-500 uppercase block mb-1">Website Name</label><input name="site_name" type="text" value="{{ config.site_name }}" class="w-full bg-black border border-gray-700 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none"></div>
                    <div><label class="text-[10px] text-gray-500 uppercase block mb-1">XP Per Message</label><input name="xp_msg" type="number" value="{{ config.xp_per_message }}" class="w-full bg-black border border-gray-700 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none"></div>
                    <div><label class="text-[10px] text-gray-500 uppercase block mb-1">Aura Per Like</label><input name="aura_like" type="number" value="{{ config.aura_per_like }}" class="w-full bg-black border border-gray-700 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none"></div>
                    <div><label class="text-[10px] text-gray-500 uppercase block mb-1">Announcement Min XP</label><input name="min_xp_announce" type="number" value="{{ config.announcement_min_xp }}" class="w-full bg-black border border-gray-700 rounded px-3 py-2 text-sm focus:border-purple-500 outline-none"></div>
                    <div class="grid grid-cols-2 gap-6 mt-4 pt-4 border-t border-gray-800">
                        <div>
                            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-2 flex items-center gap-2">
                                <span class="text-yellow-500">üî•</span> 7-Day Bonus (XP)
                            </label>
                            <input type="number" name="streak_7" value="{{ config.streak_bonus_7_day }}" 
                                class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white font-mono focus:border-yellow-500 outline-none transition placeholder-gray-600">
                            <p class="text-[9px] text-gray-600 mt-1">Awarded when user hits 7 days.</p>
                        </div>
                        
                        <div>
                            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-2 flex items-center gap-2">
                                <span class="text-purple-500">üëë</span> 30-Day Bonus (XP)
                            </label>
                            <input type="number" name="streak_30" value="{{ config.streak_bonus_30_day }}" 
                                class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white font-mono focus:border-purple-500 outline-none transition placeholder-gray-600">
                            <p class="text-[9px] text-gray-600 mt-1">Awarded when user hits 30 days.</p>
                        </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded text-xs font-bold transition shadow-[0_0_20px_rgba(37,99,235,0.3)]">SAVE CONFIGURATION</button>
                </div>
            </form>
            </div>

             <div class="p-5 bg-gray-900 rounded-xl border border-gray-800">
                <h3 class="text-xs font-bold text-yellow-500 uppercase mb-4 flex justify-between items-center">
                    <span>üí≥ Subscription Packages</span>
                    <button onclick="openPackageModal()" class="text-[10px] bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded transition">+ NEW</button>
                </h3>
                <div class="grid grid-cols-3 gap-4">
                    {% for name, details in config.subscription_packages.items %}
                    <div class="relative p-4 bg-black border border-gray-700 rounded text-center group hover:border-yellow-500/50 transition">
                        <form method="POST" action="{% url 'manage_packages' %}" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                            {% csrf_token %}<input type="hidden" name="action" value="delete"><input type="hidden" name="pkg_name" value="{{ name }}">
                            <button class="text-red-500 hover:text-red-400 font-bold text-xs">‚úï</button>
                        </form>
                        <p class="text-sm font-bold text-white">{{ name }}</p>
                        <p class="text-xs text-gray-500">Rs. {{ details.price }}</p>
                        <ul class="text-[10px] text-gray-400 mt-2 space-y-1 text-left pl-2">
                            {% for feature in details.features %}
                                <li>‚Ä¢ {{ feature }}</li>
                            {% endfor %}
                        </ul>
                        <button onclick="openPackageModal('{{ name }}', '{{ details.price }}', '{{ details.xp_mult }}', `{{ details.features|join:'\n' }}`)" class="mt-3 text-[10px] w-full bg-gray-800 hover:bg-gray-700 py-1 rounded">Edit Features</button>
                    </div>
                    {% endfor %}
                </div>
             </div>

            <div class="p-5 bg-gray-900 rounded-xl border border-gray-800">
                <h3 class="text-xs font-bold text-pink-500 uppercase mb-4">üéµ AirWave Music Studio</h3>
                
                <form method="POST" action="{% url 'manage_music' %}" enctype="multipart/form-data" class="grid grid-cols-5 gap-4 mb-6 pb-6 border-b border-gray-800">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="upload">
                    <input type="text" name="title" placeholder="Station Name" class="bg-black border border-gray-700 rounded px-3 py-2 text-xs text-white" required>
                    <input type="text" name="artist" placeholder="Artist" class="bg-black border border-gray-700 rounded px-3 py-2 text-xs text-white" required>
                    <select name="category" class="bg-black border border-gray-700 rounded px-3 py-2 text-xs text-white">
                        <option value="love">Love / Romantic</option>
                        <option value="sad">Sad / Heartbreak</option>
                        <option value="peaceful">Peaceful / Healing</option>
                        <option value="travel">Travel / Vibe</option>
                        <option value="mashup">Mashups / Remix</option>
                    </select>
                    <input type="url" name="audio_url" placeholder="Paste Link" class="bg-black border border-gray-700 rounded px-3 py-2 text-xs text-white" required>
                    <button class="bg-pink-600 hover:bg-pink-500 text-white rounded text-xs font-bold">ADD</button>
                </form>

                <div class="overflow-y-auto max-h-64 space-y-2">
                    {% for track in music_tracks %}
                    <div class="flex items-center justify-between p-2 bg-black/50 rounded border border-gray-800 hover:border-pink-500/30 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-gray-800 rounded flex items-center justify-center text-xs">üéµ</div>
                            <div>
                                <p class="text-xs font-bold text-white">{{ track.title }}</p>
                                <p class="text-[10px] text-gray-500">{{ track.artist }} ‚Ä¢ {{ track.category }}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            {% if config.default_track == track %}
                                <span class="text-[10px] text-green-400 border border-green-500/30 px-2 py-1 rounded">DEFAULT</span>
                                <button type="button" onclick="openMusicModal('{{ track.id }}', '{{ track.title }}', '{{ track.artist }}', '{{ track.audio_url }}', '{{ track.category }}')" class="text-[10px] text-blue-400 hover:text-white">Edit</button>
                            {% else %}
                                <form method="POST" action="{% url 'manage_music' %}">
                                    {% csrf_token %}<input type="hidden" name="action" value="set_default"><input type="hidden" name="track_id" value="{{ track.id }}">
                                    <button class="text-[10px] text-gray-400 hover:text-white">Make Default</button>
                                </form>
                                <button type="button" onclick="openMusicModal('{{ track.id }}', '{{ track.title }}', '{{ track.artist }}', '{{ track.audio_url }}', '{{ track.category }}')" class="text-[10px] text-blue-400 hover:text-white">Edit</button>
                            {% endif %}
                            <form method="POST" action="{% url 'manage_music' %}">
                                {% csrf_token %}<input type="hidden" name="action" value="delete"><input type="hidden" name="track_id" value="{{ track.id }}">
                                <button class="text-red-500 hover:text-red-400 text-xs font-bold">‚úï</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="p-5 bg-gray-900 rounded-xl border border-gray-800 mt-6">
                <h3 class="text-xs font-bold text-blue-400 uppercase mb-4">üì© User Song Suggestions</h3>
                <div class="overflow-y-auto max-h-64 space-y-2">
                    {% for sugg in suggestions %}
                    <div class="flex items-center justify-between p-3 bg-black/50 rounded border border-gray-800 hover:border-blue-500/30 transition">
                        <div>
                            <p class="text-xs font-bold text-white">{{ sugg.song_name }}</p>
                            <p class="text-[10px] text-gray-500">by {{ sugg.artist_name }} ‚Ä¢ Suggested by <span class="text-blue-400">{{ sugg.user.username }}</span></p>
                            <a href="{{ sugg.link }}" target="_blank" class="text-[10px] text-gray-600 hover:text-white truncate block w-64">{{ sugg.link }}</a>
                        </div>
                        <a href="{% url 'delete_suggestion' sugg.id %}" class="text-red-500 hover:text-red-400 text-xs font-bold px-3 py-1 bg-red-900/20 rounded border border-red-900/50">Delete</a>
                    </div>
                    {% empty %}
                    <p class="text-xs text-gray-500 italic p-2">No pending suggestions.</p>
                    {% endfor %}
                </div>
            </div>

        </div>

        <div class="col-span-4 bg-gray-900 border-l border-gray-800 flex flex-col h-full rounded-l-xl">
            <div class="p-4 border-b border-gray-800 bg-gray-900 sticky top-0 z-10">
                <h2 class="text-sm font-bold text-gray-300 uppercase tracking-widest">User Database</h2>
                <input type="text" placeholder="Search Pilot..." class="w-full mt-3 bg-black border border-gray-700 rounded px-3 py-1.5 text-xs text-white focus:border-yellow-500 outline-none">
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll">
                {% for profile in all_profiles %}
                <div class="p-3 border-b border-gray-800 hover:bg-black transition group relative">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center overflow-hidden border border-gray-700">
                                {% if profile.profile_picture %}<img src="{{ profile.profile_picture.url }}" class="w-full h-full object-cover">{% else %}<span class="text-xs font-bold text-gray-500">{{ profile.user.username|slice:":1" }}</span>{% endif %}
                            </div>
                            <div>
                                <p class="text-xs font-bold text-white flex items-center gap-2">
                                    {{ profile.user.username }}
                                    <span class="text-[9px] px-1.5 py-0.5 rounded border border-gray-700 text-gray-500">{{ profile.subscription_tier }}</span>
                                    {% if not profile.user.is_active %}<span class="text-[9px] bg-red-600 text-white px-1 rounded">BANNED</span>{% endif %}
                                </p>
                                <div class="flex gap-3 mt-1 text-[10px]">
                                    <span class="text-blue-400">{{ profile.xp }} XP</span>
                                    <span class="text-yellow-600">{{ profile.aura }} Aura</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onclick="openAmountModal('{{ profile.user.id }}', 'give_xp', 'Send XP')" class="flex-1 py-1 bg-blue-900/30 text-blue-400 text-[10px] rounded hover:bg-blue-600 hover:text-white transition">XP</button>
                        <button onclick="openAmountModal('{{ profile.user.id }}', 'give_aura', 'Send Aura')" class="flex-1 py-1 bg-yellow-900/30 text-yellow-400 text-[10px] rounded hover:bg-yellow-600 hover:text-white transition">Aura</button>
                        <button onclick="openGiftModal('{{ profile.user.id }}', '{{ profile.user.username }}')" class="flex-1 py-1 bg-purple-900/30 text-purple-400 text-[10px] rounded hover:bg-purple-600 hover:text-white transition">Gift</button>
                        
                        <form method="POST" action="{% url 'god_mode_action' %}" onsubmit="return confirm('Ban this user?');" class="flex-1">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="ban_user">
                            <input type="hidden" name="user_id" value="{{ profile.user.id }}">
                            <button class="w-full py-1 bg-red-900/30 text-red-400 text-[10px] rounded hover:bg-red-600 hover:text-white transition">BAN</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="amountModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100] backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 p-6 rounded-2xl w-80 shadow-2xl">
        <h3 id="amountTitle" class="text-white font-bold mb-4">Send Resource</h3>
        <form method="POST" action="{% url 'god_mode_action' %}">
            {% csrf_token %}
            <input type="hidden" id="amount_user_id" name="user_id">
            <input type="hidden" id="amount_action" name="action">
            <label class="text-[10px] text-gray-500 uppercase">Amount</label>
            <input type="number" name="amount" placeholder="e.g. 500" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-4 text-sm text-white focus:border-blue-500 outline-none">
            <div class="flex gap-2">
                <button type="button" onclick="document.getElementById('amountModal').style.display='none'" class="flex-1 bg-gray-800 text-gray-400 py-2 rounded text-xs">Cancel</button>
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-xs transition">Confirm</button>
            </div>
        </form>
    </div>
</div>

<div id="giftModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100] backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 p-6 rounded-2xl w-80 shadow-2xl">
        <h3 class="text-white font-bold mb-4">Gift Premium Rank</h3>
        <p id="giftUser" class="text-xs text-gray-400 mb-4"></p>
        <form method="POST" action="{% url 'god_mode_action' %}">
            {% csrf_token %}
            <input type="hidden" id="gift_user_id" name="user_id">
            <input type="hidden" name="action" value="gift_premium">
            <label class="text-[10px] text-gray-500 uppercase">Select Package</label>
            <select name="pkg_name" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-4 text-sm text-white focus:border-purple-500 outline-none">
                {% for name in config.subscription_packages %}
                    <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>
            <div class="flex gap-2">
                <button type="button" onclick="document.getElementById('giftModal').style.display='none'" class="flex-1 bg-gray-800 text-gray-400 py-2 rounded text-xs">Cancel</button>
                <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded text-xs transition">Gift üéÅ</button>
            </div>
        </form>
    </div>
</div>

<div id="pkgModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100] backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 p-6 rounded-2xl w-96 shadow-2xl">
        <h3 class="text-white font-bold mb-4">Manage Package</h3>
        <form method="POST" action="{% url 'manage_packages' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_or_edit">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-[10px] text-gray-500 uppercase">Name</label><input type="text" id="pkg_name" name="pkg_name" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-3 text-sm text-white outline-none"></div>
                <div><label class="text-[10px] text-gray-500 uppercase">Price</label><input type="number" id="pkg_price" name="pkg_price" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-3 text-sm text-white outline-none"></div>
            </div>
            <label class="text-[10px] text-gray-500 uppercase">XP Multiplier</label><input type="number" step="0.1" id="pkg_mult" name="pkg_mult" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-3 text-sm text-white outline-none">
            <label class="text-[10px] text-gray-500 uppercase">Features</label><textarea id="pkg_features" name="pkg_features" rows="3" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-4 text-sm text-white outline-none" placeholder="2x XP Boost&#10;Blue Glow"></textarea>
            <div class="flex gap-2"><button type="button" onclick="document.getElementById('pkgModal').style.display='none'" class="flex-1 bg-gray-800 text-gray-400 py-2 rounded text-xs">Cancel</button><button type="submit" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 rounded text-xs transition">Save</button></div>
        </form>
    </div>
</div>

<div id="musicModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100] backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 p-6 rounded-2xl w-96 shadow-2xl">
        <h3 class="text-white font-bold mb-4">Edit Station</h3>
        <form method="POST" action="{% url 'manage_music' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit">
            <input type="hidden" id="music_id" name="track_id">
            <label class="text-[10px] text-gray-500 uppercase">Title</label>
            <input type="text" id="music_title" name="title" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-3 text-sm text-white outline-none">
            <label class="text-[10px] text-gray-500 uppercase">Artist</label>
            <input type="text" id="music_artist" name="artist" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-3 text-sm text-white outline-none">
            <label class="text-[10px] text-gray-500 uppercase">URL</label>
            <input type="url" id="music_url" name="audio_url" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-3 text-sm text-white outline-none">
            <label class="text-[10px] text-gray-500 uppercase">Category</label>
            <select id="music_cat" name="category" class="w-full bg-black border border-gray-700 rounded px-3 py-2 mb-4 text-sm text-white outline-none">
                <option value="love">Love / Romantic</option>
                <option value="sad">Sad / Heartbreak</option>
                <option value="peaceful">Peaceful / Healing</option>
                <option value="travel">Travel / Vibe</option>
                <option value="mashup">Mashups / Remix</option>
            </select>
            <div class="flex gap-2">
                <button type="button" onclick="document.getElementById('musicModal').style.display='none'" class="flex-1 bg-gray-800 text-gray-400 py-2 rounded text-xs">Cancel</button>
                <button type="submit" class="flex-1 bg-pink-600 hover:bg-pink-500 text-white font-bold py-2 rounded text-xs transition">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
    const graphData = JSON.parse('{{ graph_data|safe }}');
    const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#6B7280' } }, y: { grid: { color: '#1F2937', borderDash: [5, 5] }, ticks: { color: '#6B7280' } } } };
    const ctx = document.getElementById('userGraph').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,400); grad.addColorStop(0, 'rgba(59,130,246,0.5)'); grad.addColorStop(1, 'rgba(59,130,246,0)');
    new Chart(ctx, { type: 'line', data: { labels: graphData.labels, datasets: [{ label: 'Users', data: graphData.users, borderColor: '#3B82F6', borderWidth: 2, backgroundColor: grad, fill: true, tension: 0.4, pointRadius: 0 }] }, options: commonOptions });
    new Chart(document.getElementById('revenueGraph'), { type: 'bar', data: { labels: graphData.labels, datasets: [{ label: 'Revenue', data: graphData.revenue, backgroundColor: '#EAB308', borderRadius: 4 }] }, options: commonOptions });

    function openPackageModal(name='', price='', mult='', features='') {
        document.getElementById('pkg_name').value = name;
        document.getElementById('pkg_price').value = price;
        document.getElementById('pkg_mult').value = mult;
        document.getElementById('pkg_features').value = features;
        document.getElementById('pkgModal').style.display = 'flex';
    }
    function openMusicModal(id, title, artist, url, cat) {
        document.getElementById('music_id').value = id;
        document.getElementById('music_title').value = title;
        document.getElementById('music_artist').value = artist;
        document.getElementById('music_url').value = url;
        document.getElementById('music_cat').value = cat;
        document.getElementById('musicModal').style.display = 'flex';
    }
    function openAmountModal(userId, action, title) { document.getElementById('amount_user_id').value = userId; document.getElementById('amount_action').value = action; document.getElementById('amountTitle').innerText = title; document.getElementById('amountModal').style.display = 'flex'; }
    function openGiftModal(userId, username) { document.getElementById('gift_user_id').value = userId; document.getElementById('giftUser').innerText = "Gifting to: " + username; document.getElementById('giftModal').style.display = 'flex'; }
</script>
{% endblock %}