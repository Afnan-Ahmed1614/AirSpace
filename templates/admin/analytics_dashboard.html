{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<style>
    :root {
        --bg-dark: #121212;
        --card-bg: #1e1e1e;
        --accent: #00d4ff;
        --text-main: #e0e0e0;
        --text-muted: #a0a0a0;
        --success: #00ff9d;
        --purple: #bb86fc;
        --danger: #ff5252;
    }
    
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
    
    /* FILTERS */
    .filter-bar { display: flex; justify-content: flex-end; margin-bottom: 20px; gap: 10px; }
    .filter-btn {
        background: var(--card-bg); border: 1px solid #333; color: var(--text-muted);
        padding: 8px 16px; border-radius: 6px; cursor: pointer; text-decoration: none; transition: 0.3s;
    }
    .filter-btn.active, .filter-btn:hover { background: var(--accent); color: #000; font-weight: bold; }

    /* GRID LAYOUT */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* 4 Columns standard */
        gap: 20px;
        margin-bottom: 20px;
    }

    /* KPI CARDS */
    .kpi-card {
        background: var(--card-bg); padding: 20px; border-radius: 12px;
        border-left: 4px solid var(--accent); position: relative;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .kpi-card h3 { color: var(--text-muted); font-size: 0.85rem; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
    .kpi-card .value { font-size: 2rem; font-weight: 700; color: #fff; }
    .kpi-card .sub-text { font-size: 0.8rem; color: var(--success); margin-top: 5px; }

    /* COLORS FOR KPI BORDERS */
    .kpi-online { border-color: var(--success); }
    .kpi-rev { border-color: #ffd700; }
    .kpi-msg { border-color: var(--purple); }
    .kpi-sess { border-color: var(--danger); }

    /* CHART CONTAINERS */
    .chart-box {
        background: var(--card-bg); border-radius: 12px; padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        min-height: 300px;
    }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .chart-title { font-size: 1.1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 10px; }

    /* TABLES */
    .custom-table { width: 100%; border-collapse: collapse; }
    .custom-table th { text-align: left; color: var(--text-muted); padding: 10px; border-bottom: 1px solid #333; font-size: 0.8rem; }
    .custom-table td { padding: 12px 10px; border-bottom: 1px solid #2a2a2a; font-size: 0.9rem; }
    .custom-table tr:last-child td { border-bottom: none; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; background: #333; }
    
    /* SPECIFIC SPANS */
    .col-span-2 { grid-column: span 2; }
    .col-span-4 { grid-column: span 4; }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div>
        <h1 style="font-size: 2rem; margin: 0; background: linear-gradient(to right, #00d4ff, #bb86fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            ‚ö° AIRSPACE ANALYTICS V9
        </h1>
        <div style="color: var(--success); font-size: 0.9rem;">Status: ‚óè All Systems Operational</div>
    </div>
    
    <div class="filter-bar">
        <a href="?filter=24H" class="filter-btn {% if current_filter == '24H' %}active{% endif %}">24H</a>
        <a href="?filter=7D" class="filter-btn {% if current_filter == '7D' %}active{% endif %}">7 Days</a>
        <a href="?filter=30D" class="filter-btn {% if current_filter == '30D' %}active{% endif %}">30 Days</a>
        <a href="?filter=LIFETIME" class="filter-btn {% if current_filter == 'LIFETIME' %}active{% endif %}" style="border-color: var(--purple);">LIFETIME</a>
    </div>
</div>

<div class="dashboard-grid" style="grid-template-columns: repeat(6, 1fr);">
    <div class="kpi-card kpi-online">
        <h3>Online Now</h3>
        <div class="value">{{ online_count }}</div>
        <div class="sub-text">Live Users</div>
    </div>
    <div class="kpi-card">
        <h3>DAU</h3>
        <div class="value">{{ dau_count }}</div>
        <div class="sub-text">Active Today</div>
    </div>
    <div class="kpi-card">
        <h3>Stickiness</h3>
        <div class="value">{{ stickiness }}%</div>
        <div class="sub-text">Retention Rate</div>
    </div>
    <div class="kpi-card kpi-rev">
        <h3>Est. Revenue</h3>
        <div class="value">Rs. {{ revenue }}</div>
        <div class="sub-text">Total Generated</div>
    </div>
    <div class="kpi-card kpi-msg">
        <h3>Total Messages</h3>
        <div class="value">{{ total_msgs }}</div>
        <div class="sub-text">Chat Volume</div>
    </div>
    <div class="kpi-card kpi-sess">
        <h3>Avg Session</h3>
        <div class="value">{{ avg_session }}m</div>
        <div class="sub-text">Time Spent</div>
    </div>
</div>

<div class="dashboard-grid" style="grid-template-columns: 2fr 1fr 1fr;">
    <div class="chart-box">
        <div class="chart-header">
            <div class="chart-title">üåç Top Cities</div>
        </div>
        <table class="custom-table">
            <thead>
                <tr><th>CITY NAME</th><th>ACTIVE USERS</th><th>STATUS</th></tr>
            </thead>
            <tbody>
                {% for city in top_cities %}
                <tr>
                    <td>{{ city.city }}</td>
                    <td style="color: var(--accent); font-weight: bold;">{{ city.count }}</td>
                    <td><span class="badge" style="color: var(--success); background: rgba(0,255,157,0.1);">Verified</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="chart-box">
        <div class="chart-header"><div class="chart-title">‚öß Demographics</div></div>
        <canvas id="genderChart"></canvas>
    </div>

    <div class="chart-box">
        <div class="chart-header"><div class="chart-title">üì± Device Type</div></div>
        <canvas id="platformChart"></canvas>
        <div style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: #888;">Mobile vs Desktop</div>
    </div>
</div>

<div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
    <div class="chart-box">
        <div class="chart-header"><div class="chart-title">‚è∞ Peak Active Hours (Local Time)</div></div>
        <canvas id="hoursChart" height="100"></canvas>
    </div>

    <div class="chart-box">
        <div class="chart-header"><div class="chart-title">üèÜ User Ranks</div></div>
        <canvas id="rankChart"></canvas>
    </div>
</div>

<div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
    <div class="chart-box">
        <div class="chart-header"><div class="chart-title">üí¨ Top 10 Hyper-Active Users</div></div>
        <canvas id="activeUsersChart"></canvas>
    </div>

    <div class="chart-box">
        <div class="chart-header"><div class="chart-title">‚ú® Top XP Earners (Aura)</div></div>
        <table class="custom-table">
            <thead><tr><th>RANK</th><th>USER</th><th>XP</th><th>LEVEL</th></tr></thead>
            <tbody>
                {% for user in top_xp_users %}
                <tr>
                    <td>#{{ forloop.counter }}</td>
                    <td>{{ user.username }}</td>
                    <td style="color: gold;">{{ user.xp_points }} XP</td>
                    <td><span class="badge">{{ user.level }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- GENDER CHART ---
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    const rawGender = {{ gender_data|safe }}; // e.g. {"Male": 10, "Female": 2}
    new Chart(genderCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(rawGender),
            datasets: [{
                data: Object.values(rawGender),
                backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56'],
                borderWidth: 0
            }]
        },
        options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
    });

    // --- NEW: PLATFORM CHART ---
    const platformCtx = document.getElementById('platformChart').getContext('2d');
    new Chart(platformCtx, {
        type: 'pie',
        data: {
            labels: ['Mobile', 'Desktop'],
            datasets: [{
                data: {{ platform_data|safe }},
                backgroundColor: ['#bb86fc', '#03dac6'],
                borderWidth: 0
            }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
    });

    // --- NEW: PEAK HOURS CHART ---
    const hoursCtx = document.getElementById('hoursChart').getContext('2d');
    new Chart(hoursCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => i + ':00'),
            datasets: [{
                label: 'Messages',
                data: {{ hours_data|safe }},
                backgroundColor: '#00d4ff',
                borderRadius: 4
            }]
        },
        options: { scales: { x: { grid: { display: false } }, y: { grid: { color: '#333' } } } }
    });

    // --- NEW: RANK CHART ---
    const rankCtx = document.getElementById('rankChart').getContext('2d');
    new Chart(rankCtx, {
        type: 'polarArea',
        data: {
            labels: {{ rank_labels|safe }},
            datasets: [{
                data: {{ rank_values|safe }},
                backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)']
            }]
        },
        options: { scales: { r: { grid: { color: '#333' }, ticks: { display: false } } } }
    });

    // --- TOP USERS CHART (Existing) ---
    const activeCtx = document.getElementById('activeUsersChart').getContext('2d');
    new Chart(activeCtx, {
        type: 'bar',
        data: {
            labels: {{ top_users_labels|safe }},
            datasets: [{
                label: 'Messages',
                data: {{ top_users_values|safe }},
                backgroundColor: '#00d4ff',
                barThickness: 20
            }]
        },
        options: { indexAxis: 'y', scales: { x: { grid: { color: '#333' } }, y: { grid: { display: false } } } }
    });
</script>
{% endblock %}