<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airspace Analytics V9</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b0c10; --card: #1f2833; --text: #c5c6c7; --accent: #66fcf1; --accent-dim: #45a29e; --purple: #bb86fc; --danger: #cf6679; --gold: #ffd700; --warn: #ff9f43; }
        body { margin: 0; padding: 20px; background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .logo h1 { margin: 0; font-size: 28px; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        .logo span { color: var(--accent); }
        .tabs { display: flex; gap: 15px; margin-bottom: 20px; }
        .tab-btn { background: transparent; border: 1px solid #333; color: #888; padding: 10px 20px; cursor: pointer; border-radius: 5px; transition: 0.3s; font-weight: 600; }
        .tab-btn.active, .tab-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }
        .filters a { text-decoration: none; color: #888; padding: 8px 16px; border: 1px solid #333; border-radius: 4px; margin-left: 5px; font-size: 14px; transition: 0.3s; }
        .filters a:hover, .filters a.active { background: var(--card); color: #fff; border-color: #fff; }
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card); border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .card-title { font-size: 14px; color: #888; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .big-stat { font-size: 36px; font-weight: 800; color: #fff; margin-bottom: 5px; }
        .sub-stat { font-size: 13px; color: var(--accent-dim); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 10px 0; border-bottom: 1px solid #2a2a2a; color: #fff; font-size: 13px; }
        .section { display: none; }
        .section.active { display: block; }
        
        /* PHASE 3 STYLES */
        .suggestion-item { padding: 15px; border-left: 4px solid #333; background: rgba(0,0,0,0.2); margin-bottom: 10px; border-radius: 4px; }
        .suggestion-item.high { border-color: var(--danger); }
        .suggestion-item.med { border-color: var(--warn); }
        .suggestion-item.low { border-color: var(--accent); }
        .suggestion-text { font-size: 14px; margin-bottom: 5px; }
        .suggestion-meta { font-size: 11px; color: #666; text-transform: uppercase; }
        
        .alert-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; }
        .alert-item:last-child { border-bottom: none; }
        .alert-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase; font-weight: bold; }
        .alert-badge.critical { background: var(--danger); color: #fff; }
        .alert-badge.warning { background: var(--warn); color: #000; }
        .alert-badge.info { background: var(--accent); color: #000; }
    </style>
</head>
<body>

    <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333;">
        <div class="logo">
            <h1 style="margin:0; font-size:24px;">AirSpace <span>Analytics</span></h1>
            <div style="font-size: 12px; color: #00ff9d; margin-top: 5px;">‚óè Phase 3: Intelligence Layer Active</div>
        </div>

        <div style="display: flex; gap: 10px; background: #1a1a1a; padding: 5px; border-radius: 8px;">
            <a href="/control-tower/" style="text-decoration: none; color: #fff; background: #333; padding: 8px 15px; border-radius: 6px; font-size: 12px; font-weight: 600; transition: 0.2s;" onmouseover="this.style.background='#ff0055'" onmouseout="this.style.background='#333'">üïπÔ∏è Control Tower</a>
            <a href="/admin/" style="text-decoration: none; color: #fff; background: #333; padding: 8px 15px; border-radius: 6px; font-size: 12px; font-weight: 600; transition: 0.2s;" onmouseover="this.style.background='#00ff9d'; this.style.color='#000'" onmouseout="this.style.background='#333'; this.style.color='#fff'">‚öôÔ∏è DB Admin</a>
        </div>

        <div class="filters">
            <a href="?filter=24H" class="{% if filter == '24H' %}active{% endif %}">24H</a>
            <a href="?filter=7D" class="{% if filter == '7D' %}active{% endif %}">7 Days</a>
            <a href="?filter=30D" class="{% if filter == '30D' %}active{% endif %}">30 Days</a>
            <a href="?filter=LIFETIME" class="{% if filter == 'LIFETIME' %}active{% endif %}" style="border-color: var(--purple);">LIFETIME</a>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('overview')">Overview (Phase 1)</button>
        <button class="tab-btn" onclick="switchTab('behavior')">Behavior (Phase 2)</button>
        <button class="tab-btn" onclick="switchTab('insights')" style="border-color: var(--danger); color: var(--danger);">Insights (Phase 3)</button>
    </div>

    <div id="overview" class="section active">
        <div class="grid-container" style="grid-template-columns: repeat(6, 1fr);">
            <div class="card" style="border-left: 3px solid #00ff9d;"><div class="card-title">Online</div><div class="big-stat">{{ online_count }}</div><div class="sub-stat">Live</div></div>
            <div class="card"><div class="card-title">DAU</div><div class="big-stat">{{ dau_count }}</div><div class="sub-stat">Today</div></div>
            <div class="card"><div class="card-title">Stickiness</div><div class="big-stat">{{ stickiness }}%</div><div class="sub-stat">Rate</div></div>
            <div class="card" style="border-left: 3px solid gold;"><div class="card-title">Revenue</div><div class="big-stat">Rs.{{ revenue }}</div><div class="sub-stat">Total</div></div>
            <div class="card" style="border-left: 3px solid var(--purple);"><div class="card-title">Msgs</div><div class="big-stat">{{ total_msgs }}</div><div class="sub-stat">Volume</div></div>
            <div class="card" style="border-left: 3px solid var(--danger);"><div class="card-title">Session</div><div class="big-stat">{{ avg_session }}m</div><div class="sub-stat">Avg</div></div>
        </div>
        <div class="grid-container" style="grid-template-columns: 1.5fr 1fr 1fr 1fr;">
            <div class="card">
                <div class="card-title">üåç Top Cities</div>
                <table>{% for city in top_cities %}<tr><td>{{ city.city }}</td><td style="color:var(--accent);">{{ city.count }}</td></tr>{% empty %}<tr><td colspan="2">No Data</td></tr>{% endfor %}</table>
            </div>
            <div class="card"><div class="card-title">‚öß Gender</div><canvas id="genderChart"></canvas></div>
            <div class="card"><div class="card-title">üì± Device</div><canvas id="platformChart"></canvas></div>
            <div class="card" style="border-top: 2px solid gold;"><div class="card-title">üëë Subs</div><canvas id="subsChart"></canvas></div>
        </div>
        <div class="grid-container" style="grid-template-columns: 2fr 1fr;">
            <div class="card"><div class="card-title">‚è∞ Activity</div><canvas id="hoursChart" height="100"></canvas></div>
            <div class="card"><div class="card-title">üèÜ Tiers</div><canvas id="rankChart"></canvas></div>
        </div>
        <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="card"><div class="card-title">üí¨ Chatters</div><canvas id="chatChart"></canvas></div>
            <div class="card"><div class="card-title" style="color: gold;">‚ú® Top XP</div><table>{% for user in top_xp_users %}<tr><td>{{ forloop.counter }}. {{ user.display_name }}</td><td style="color:gold;">{{ user.xp }}</td></tr>{% endfor %}</table></div>
            <div class="card"><div class="card-title" style="color: var(--purple);">üîÆ Top Aura</div><table>{% for user in top_aura_users %}<tr><td>{{ forloop.counter }}. {{ user.display_name }}</td><td style="color:var(--purple);">{{ user.aura }}</td></tr>{% endfor %}</table></div>
        </div>
    </div>

    <div id="behavior" class="section">
        <div class="grid-container" style="grid-template-columns: repeat(4, 1fr);">
            <div class="card" style="border-left: 3px solid #ff0055;"><div class="card-title">Power Users</div><div class="big-stat">{{ power_users_count }}</div><div class="sub-stat">XP > 1000</div></div>
            <div class="card" style="border-left: 3px solid #00aaff;"><div class="card-title">Day-7 Retention</div><div class="big-stat">{{ retention_rate }}%</div><div class="sub-stat">Coming Back?</div></div>
            <div class="card" style="border-left: 3px solid orange;"><div class="card-title">Music Popularity</div><div class="big-stat">{{ total_favorites }}</div><div class="sub-stat">Total Favorites</div></div>
            <div class="card" style="border-left: 3px solid #00ff9d;"><div class="card-title">Multi-Feature</div><div class="big-stat">{{ multi_feature_count }}</div><div class="sub-stat">Chat + Music Users</div></div>
        </div>
        <div class="grid-container" style="grid-template-columns: 1fr 2fr;">
            <div class="card"><div class="card-title">üìù Msg Format</div><canvas id="msgTypeChart"></canvas><div style="text-align:center; font-size:11px; margin-top:5px; color:#666;">Avg: {{ avg_msg_per_user }} msgs/user</div></div>
            <div class="grid-container" style="grid-template-columns: 1fr 1fr; margin-bottom: 0;">
                <div class="card"><div class="card-title">üéµ Trending Tracks</div><table><thead><tr><th>SONG</th><th>FAVS</th></tr></thead><tbody>{% for track in top_tracks %}<tr><td style="font-size:12px;">{{ track.title }}</td><td style="color: orange; font-weight: bold;">{{ track.fav_count }}</td></tr>{% empty %}<tr><td colspan="2" style="text-align:center;">No Favorites</td></tr>{% endfor %}</tbody></table></div>
                <div class="card"><div class="card-title">üé∏ Genre Interest</div><canvas id="genreChart"></canvas></div>
            </div>
        </div>
        <div class="grid-container" style="grid-template-columns: 2fr 1fr;">
            <div class="card"><div class="card-title">üì¢ Room Heatmap (@Mentions: {{ mentions_count }})</div><canvas id="roomChart" height="100"></canvas></div>
            <div class="card"><div class="card-title">üëª Lurkers vs Chatters</div><canvas id="participationChart"></canvas></div>
        </div>
    </div>

    <div id="insights" class="section">
        
        <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
            <div class="card" style="border-left: 4px solid var(--danger);">
                <div class="card-title">üìâ Churn Risk</div>
                <canvas id="churnChart"></canvas>
            </div>
            <div class="card" style="border-left: 4px solid var(--accent);">
                <div class="card-title">üîÆ Forecast</div>
                <div style="margin-top: 10px;">
                    <div style="color: #888; font-size: 11px;">Expected DAU</div>
                    <div style="font-size: 24px; font-weight: bold; color: #fff;">{{ predicted_dau }}</div>
                    <div style="color: #888; font-size: 11px; margin-top: 5px;">Expected Peak</div>
                    <div style="font-size: 16px; color: var(--gold);">{{ expected_peak }}</div>
                </div>
            </div>
            
            <div class="card col-2" style="grid-column: span 2;">
                <div class="card-title">üö® Smart Alerts (System Signals)</div>
                <div style="max-height: 150px; overflow-y: auto;">
                    {% for alert in alerts %}
                    <div class="alert-item">
                        <span style="font-size: 13px; color: #ddd;">{{ alert.msg }}</span>
                        <span class="alert-badge {{ alert.level }}">{{ alert.type }}</span>
                    </div>
                    {% empty %}
                    <div style="text-align: center; padding: 20px; color: #555;">No anomalies detected. System Stable.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="grid-container" style="grid-template-columns: 2fr 1fr 1fr;">
            <div class="card">
                <div class="card-title">ü§ñ Automation Suggestions</div>
                <div style="max-height: 200px; overflow-y: auto;">
                    {% for suggestion in suggestions %}
                    <div class="suggestion-item {{ suggestion.severity }}">
                        <div class="suggestion-text">{{ suggestion.msg }}</div>
                        <div class="suggestion-meta">{{ suggestion.type }} ‚Ä¢ {{ suggestion.severity }} Priority</div>
                    </div>
                    {% empty %}
                    <div style="text-align: center; padding: 20px; color: #555;">No growth actions needed right now.</div>
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìà Growth Signals</div>
                <div style="margin-top: 15px;">
                    <div style="color: #888; font-size: 12px;">Close to Level Up</div>
                    <div style="font-size: 24px; color: #fff;">{{ close_to_level }} <span style="font-size:12px; color:#888;">users</span></div>
                    <div style="border-top: 1px solid #333; margin: 10px 0;"></div>
                    <div style="color: #888; font-size: 12px;">Best Time for CTA</div>
                    <div style="font-size: 18px; color: var(--accent);">{{ best_cta_time }}</div>
                </div>
            </div>

            <div class="card" style="border-top: 2px solid {% if system_load == 'Normal' %}#00ff9d{% else %}var(--danger){% endif %};">
                <div class="card-title">‚ù§Ô∏è System Health</div>
                <div style="margin-top: 15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                        <span>Load:</span> <span style="color:#fff;">{{ system_load }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>Latency:</span> <span style="color:#fff;">~{{ latency_ms }}ms</span>
                    </div>
                    <div style="margin-top: 15px; font-size: 10px; color: #555;">Socket Hooks Active</div>
                </div>
            </div>
        </div>
        
        <div class="grid-container">
             <div class="card" style="grid-column: span 4;">
                <div class="card-title">üöÄ Conversion Funnel</div>
                <canvas id="funnelChart" height="50"></canvas>
            </div>
        </div>
    </div>

    <script>
        Chart.defaults.color = '#888'; Chart.defaults.borderColor = '#333';
        function switchTab(t){document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));document.getElementById(t).classList.add('active');event.target.classList.add('active');}

        // PHASE 1
        new Chart(document.getElementById('genderChart'), { type: 'doughnut', data: { labels: {{ gender_labels|safe }}, datasets: [{ data: {{ gender_values|safe }}, backgroundColor: ['#66fcf1', '#cf6679'], borderWidth: 0 }] }, options: { cutout: '75%', plugins: { legend: { display: false } } } });
        new Chart(document.getElementById('platformChart'), { type: 'pie', data: { labels: ['Mobile', 'Desktop'], datasets: [{ data: {{ platform_data|safe }}, backgroundColor: ['#45a29e', '#1f2833'], borderWidth: 0 }] }, options: { plugins: { legend: { display: false } } } });
        new Chart(document.getElementById('subsChart'), { type: 'doughnut', data: { labels: ['Free', 'Premium'], datasets: [{ data: {{ subs_data|safe }}, backgroundColor: ['#555', '#FFD700'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { legend: { display: false } } } });
        new Chart(document.getElementById('hoursChart'), { type: 'line', data: { labels: Array.from({length: 24},(_,i)=>i+':00'), datasets: [{ label: 'Activity', data: {{ hours_data|safe }}, borderColor: '#66fcf1', tension: 0.4, fill: true, backgroundColor: 'rgba(102, 252, 241, 0.1)' }] }, options: { scales: { x: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
        new Chart(document.getElementById('rankChart'), { type: 'polarArea', data: { labels: {{ rank_labels|safe }}, datasets: [{ data: {{ rank_values|safe }}, backgroundColor: ['rgba(102, 252, 241, 0.6)', 'rgba(207, 102, 121, 0.6)', 'rgba(187, 134, 252, 0.6)'] }] }, options: { scales: { r: { ticks: { display: false }, grid: { color: '#333' } } }, plugins: { legend: { display: false } } } });
        new Chart(document.getElementById('chatChart'), { type: 'bar', data: { labels: {{ chat_labels|safe }}, datasets: [{ data: {{ chat_values|safe }}, backgroundColor: '#bb86fc', barThickness: 8 }] }, options: { indexAxis: 'y', scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } } });

        // PHASE 2
        new Chart(document.getElementById('msgTypeChart'), { type: 'bar', data: { labels: ['Text', 'Voice', 'Image'], datasets: [{ data: {{ msg_type_data|safe }}, backgroundColor: ['#444', '#00d4ff', '#ff0055'], borderRadius: 5 }] }, options: { plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#222' } }, x: { grid: { display: false } } } } });
        new Chart(document.getElementById('roomChart'), { type: 'bar', data: { labels: {{ room_labels|safe }}, datasets: [{ label: 'Messages', data: {{ room_values|safe }}, backgroundColor: 'rgba(255, 215, 0, 0.6)', borderColor: 'gold', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, grid: { color: '#222' } }, x: { grid: { display: false } } } } });
        new Chart(document.getElementById('participationChart'), { type: 'pie', data: { labels: ['Active Chatters', 'Silent Lurkers'], datasets: [{ data: {{ participation_data|safe }}, backgroundColor: ['#00ff9d', '#222'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'bottom' } } } });
        new Chart(document.getElementById('genreChart'), { type: 'doughnut', data: { labels: {{ genre_labels|safe }}, datasets: [{ label: 'Favorites', data: {{ genre_values|safe }}, backgroundColor: ['#ff9f43', '#00d4ff', '#ff0055', '#00ff9d'], borderWidth: 0 }] }, options: { cutout: '60%', plugins: { legend: { display: false } } } });

        // PHASE 3 (COMPLETE)
        new Chart(document.getElementById('churnChart'), { type: 'doughnut', data: { labels: ['Safe', 'Warning', 'High Risk'], datasets: [{ data: {{ churn_data|safe }}, backgroundColor: ['#00ff9d', '#ff9f43', '#ff0055'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
        new Chart(document.getElementById('funnelChart'), { type: 'bar', data: { labels: ['Visitors', 'Active', 'Engaged', 'Paid'], datasets: [{ label: 'Users', data: {{ funnel_data|safe }}, backgroundColor: ['#444', '#00aaff', '#bb86fc', '#ffd700'], barPercentage: 0.6 }] }, options: { indexAxis: 'y', scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
    </script>
</body>
</html>